<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Wind Flow Tracker - ArcGIS</title>
    <link rel="icon" type="image/x-icon" href="../../assets/logo-small.png">
    
    
    <link rel="stylesheet" href="https://js.arcgis.com/4.34/esri/themes/dark/main.css">

    <link rel="stylesheet" href="../../styles/global.css">
    <link rel="stylesheet" href="../../styles/main.css">
    <link rel="stylesheet" href="../../styles/hurricane/hurricane-history.css">

    <script type="module" src="https://js.arcgis.com/calcite-components/3.3.3/calcite.esm.js"></script>
    <script src="https://js.arcgis.com/4.34/"></script>
    <script type="module" src="https://js.arcgis.com/4.34/map-components/"></script>

    <script type="module" src="../../script/current-user.js"></script>
    <script src="../../script/hurricane/hurricane.js"></script>    
</head>

<body class="calcite-mode-dark">
    <div id="container">
        <nav class="navbar" id="navbar">
            <div class="nav-container">
                <div class="logo-nav">
                    <div class="logo-icon-nav"><img src="../../assets/logo-small-bw.png" class="logo-icon"></div>
                    <div class="logo-text">AlertUnity</div>
                </div>

                <ul class="nav-links">
                    <li><a href="../hurricane.html">Home</a></li>
                    <li><a href="hurricane-history.html">History</a></li>
                    <li><a href="#" class="active">Live Map</a></li>
                    <li><a href="ocean-map.html">Ocean Winds</a></li>
                    <li><a href="teams.html">Our Teams</a></li>
                    <li><a href="../disasters/contact.html">Contact</a></li>
                </ul>

                <div class="nav-cta">
                    <a href="../disasters/sign-in.html" class="btn-nav btn-secondary" style="visibility: hidden;">Sign In</a>
                    <a href="../disasters/sign-up.html" class="btn-nav btn-primary" style="visibility: hidden;">Join Now</a>
                </div>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle dark mode">
                    <span class="theme-icon"><i class="fa-solid fa-moon"></i></span>
                </button>

                <button class="mobile-toggle">â˜°</button>
            </div>
        </nav>
        
        <arcgis-map center="-98, 39" zoom="4" id="viewDiv">
            <arcgis-zoom slot="top-left"></arcgis-zoom>
            <arcgis-expand slot="top-left">
                <arcgis-legend></arcgis-legend>
            </arcgis-expand>
            <arcgis-expand slot="top-right" expand-icon="sliders-horizontal">
                <calcite-card id="controls" class="calcite-mode-dark" style="width: 300px; max-height: 90vh; overflow: auto;">
                    <div slot="title">Wind Flow Controls</div>
                    <calcite-label>
                        Trail width
                        <calcite-slider id="trailWidth" min="0.1" max="10" value="2" step="0.1" label-handles></calcite-slider>
                    </calcite-label>
                    <calcite-label>
                        Trail length
                        <calcite-slider id="trailLength" min="0.1" max="200" value="100" label-handles></calcite-slider>
                    </calcite-label>
                    <calcite-label>
                        Density
                        <calcite-slider id="density" min="0.1" max="3" value="1" step="0.1" label-handles></calcite-slider>
                    </calcite-label>
                    <calcite-label>
                        Flow speed
                        <calcite-slider id="flowSpeed" min="0.1" max="40" value="10" step="0.1" label-handles></calcite-slider>
                    </calcite-label>
                    <calcite-label>
                        Maximum path length
                        <calcite-slider id="maxPathLength" min="0.1" max="300" value="200" label-handles></calcite-slider>
                    </calcite-label>
                    <calcite-label>
                        Flow representation
                        <calcite-segmented-control id="flowRepresentation">
                            <calcite-segmented-control-item value="flow-to">To</calcite-segmented-control-item>
                            <calcite-segmented-control-item value="flow-from" checked>From</calcite-segmented-control-item>
                        </calcite-segmented-control>
                    </calcite-label>
                    <calcite-label>
                        Cap style
                        <calcite-segmented-control id="trailCap">
                            <calcite-segmented-control-item value="butt" checked>Butt</calcite-segmented-control-item>
                            <calcite-segmented-control-item value="round">Round</calcite-segmented-control-item>
                        </calcite-segmented-control>
                        <small>*Round caps are only supported when trail width is greater than 3pt</small>
                    </calcite-label>
                    <calcite-label>
                        Effects enabled
                        <calcite-checkbox id="effectsEnabled" checked></calcite-checkbox>
                    </calcite-label>
                </calcite-card>
            </arcgis-expand>
            
            <div class="info-panel" id="infoPanel">
                <h3>Wind Information</h3>
                <div class="info-item">
                    <div class="info-label">Data Source</div>
                    <div class="info-value" id="dataSource">NLDAS Hourly</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Date</div>
                    <div class="info-value" id="dataDate">August 30, 2021</div>
                </div>
                <div class="info-item">
                    <div class="info-label">Visualization</div>
                    <div class="info-value" id="vizType">Flow Renderer</div>
                </div>
            </div>
        </arcgis-map>
    </div>

    <script type="module">
        const [Map, ImageryTileLayer] = await $arcgis.import([
            "@arcgis/core/Map.js",
            "@arcgis/core/layers/ImageryTileLayer.js",
        ]);
        
        const viewElement = document.querySelector("arcgis-map");
        
        const layer = new ImageryTileLayer({
            url: "https://tiledimageservices.arcgis.com/V6ZHFr6zdgNZuVG0/arcgis/rest/services/NLDAS_Hourly_8_30_2021/ImageServer",
            title: "Winds",
            renderer: {
                type: "flow",
                trailWidth: "2px",
                density: 1,
                visualVariables: [
                    {
                        type: "color",
                        field: "Magnitude",
                        stops: [
                            { color: [40, 146, 199, 1], value: 0 },
                            { color: [160, 194, 155, 1], value: 5 },
                            { color: [218, 230, 119, 1], value: 10 }
                        ]
                    }
                ]
            },
            effect: "bloom(1.5, 0.5px, 0)"
        });
        
        const map = new Map({
            basemap: "dark-gray-vector",
            layers: [layer]
        });
        
        viewElement.map = map;

        // Setup event listeners
        const sliderProps = ["trailWidth", "density", "maxPathLength", "flowSpeed", "trailLength"];
        sliderProps.forEach((prop) => {
            document.getElementById(prop).addEventListener("calciteSliderChange", updateRenderer);
        });
        
        document.getElementById("flowRepresentation").addEventListener("calciteSegmentedControlChange", updateRenderer);
        document.getElementById("trailCap").addEventListener("calciteSegmentedControlChange", updateRenderer);
        document.getElementById("effectsEnabled").addEventListener("calciteCheckboxChange", updateEffect);

        function updateEffect(event) {
            layer.effect = event.target.checked ? "bloom(1.5, 0.5px, 0)" : null;
        }

        function updateRenderer(event) {
            let propName = event.target.id;
            let propValue = event.target.value;
            if (propName && propValue != null) {
                let tempRenderer = layer.renderer.clone();
                tempRenderer[propName] = propValue;
                layer.renderer = tempRenderer;
            }
        }
    </script>
</body>
</html